<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TOEFL対策｜日本語→英語 4択（セッション棒グラフ対応）</title>
  <style>
    :root{
      --bg:#0e2f25;          /* 深緑ベース */
      --panel:#123c2e;       /* やや明るい深緑 */
      --accent:#16a34a;      /* 緑の差し色 */
      --accent-2:#22c55e;    /* 成功トーン */
      --text:#e8faef;        /* 文字（明） */
      --muted:#b8dbc7;       /* 補助文字 */
      --danger:#ef4444;      /* 誤答 */
      --border:#1f4b3a;      /* 枠線 */
      --btn:#145f46;
      --btn-hover:#187256;
      --btn-disabled:#1a4738;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; padding:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif;
      background:linear-gradient(180deg, var(--bg), #0a231c 60%);
      color:var(--text);
    }
    .container{ max-width:980px; margin:0 auto; padding:24px; }
    header{ display:flex; justify-content:space-between; align-items:center; gap:12px; padding:12px 16px; border:1px solid var(--border); background:var(--panel); border-radius:16px; }
    h1{ margin:0; font-size:20px; font-weight:700; letter-spacing:0.02em; }
    .badge{ font-size:12px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }

    .card{ margin-top:16px; border:1px solid var(--border); background:var(--panel); border-radius:20px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,.25);
      backdrop-filter: blur(2px);
    }
    .row{ display:flex; gap:16px; flex-wrap:wrap; }

    .stat{
      display:flex; flex-direction:column; gap:6px; padding:12px 14px; border:1px dashed var(--border); border-radius:12px; min-width:140px; align-items:flex-start; justify-content:center;
    }
    .stat .label{ font-size:12px; color:var(--muted); }
    .stat .value{ font-size:20px; font-weight:700; }

    .q-ja{ font-size:24px; margin:8px 0 14px; letter-spacing:0.02em; }

    .choices{ display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px; }
    .choice{
      display:block; width:100%; text-align:left; padding:14px 16px; border-radius:12px; border:1px solid var(--border); background:var(--btn); color:var(--text);
      cursor:pointer; font-size:16px; transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    .choice:hover{ background:var(--btn-hover); transform: translateY(-1px); }
    .choice[disabled]{ cursor:not-allowed; background:var(--btn-disabled); opacity:.7; transform:none; }

    .choice.correct{ outline:2px solid var(--accent-2); border-color:var(--accent-2); background:rgba(34,197,94,.15); }
    .choice.wrong{ outline:2px solid var(--danger); border-color:var(--danger); background:rgba(239,68,68,.1); }

    .actions{ display:flex; gap:10px; margin-top:14px; }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:var(--btn); color:var(--text); cursor:pointer; font-weight:600; }
    .btn:hover{ background:var(--btn-hover); }
    .btn[disabled]{ cursor:not-allowed; background:var(--btn-disabled); opacity:.7; }
    .btn.secondary{ background:transparent; }

    .feedback{ min-height:24px; margin-top:8px; font-weight:600; }
    .feedback.ok{ color:var(--accent-2); }
    .feedback.ng{ color:var(--danger); }

    .panel{ margin-top:16px; border:1px solid var(--border); background:var(--panel); border-radius:16px; padding:16px; }

    .chart-wrap{ width:100%; overflow:hidden; }
    canvas{ width:100%; height:180px; display:block; border-radius:12px; background: #0b241d; border:1px solid var(--border); }

    .small{ font-size:12px; color:var(--muted); }

    textarea{ width:100%; min-height:120px; border-radius:12px; border:1px solid var(--border); background:#0b241d; color:var(--text); padding:12px; }
    .inline{ display:inline-flex; gap:8px; align-items:center; }

    footer{ margin:20px 0 60px; text-align:center; color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>TOEFL対策｜日本語→英語 4択</h1>
    </header>

    <div class="card">
      <div class="row">
        <div class="stat">
          <div class="label">出題</div>
          <div class="value" id="asked">0 / 100</div>
        </div>
        <div class="stat">
          <div class="label">正答</div>
          <div class="value" id="correct">0</div>
        </div>
        <div class="stat">
          <div class="label">正答率</div>
          <div class="value" id="rate">0%</div>
        </div>
        <div class="stat">
          <div class="label">習得済み（再出題なし）</div>
          <div class="value" id="masteredCount">0</div>
        </div>
      </div>

      <div class="q-ja" id="prompt">ここに日本語が表示されます</div>
      <div class="choices" id="choices"></div>
      <div class="feedback" id="feedback"></div>
      <div class="actions">
        <button class="btn" id="nextBtn" disabled>次の問題</button>
        <button class="btn secondary" id="skipBtn">スキップ</button>
        <button class="btn secondary" id="resetBtn" title="履歴と習得語を初期化">リセット</button>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="align-items:flex-end;">
        <div style="flex:2 1 620px;">
          <div class="small" style="margin-bottom:6px;">セッション（100問）ごとの正答率（棒グラフ、最新20回表示）</div>
          <div class="chart-wrap">
            <canvas id="chart" width="900" height="180" aria-label="セッション別正答率"></canvas>
          </div>
        </div>
        <div style="flex:1 1 320px;">
          <div class="small" style="margin-bottom:6px;">カスタム単語（1行に「英語,日本語」）</div>
          <textarea id="customArea" placeholder="例) evidence,証拠
abstract,抽象的な
investigate,調査する"></textarea>
          <div class="actions" style="margin-top:8px;">
            <button class="btn" id="loadCustomBtn">読み込み</button>
            <button class="btn secondary" id="exportBtn">語彙を書き出し</button>
          </div>
          <div class="small">※ 読み込むと現在の語彙に置き換えます。習得済みは保持。ローカルストレージにセッション履歴を保存します。</div>
        </div>
      </div>
    </div>

    <footer>&copy; 2025 Toku.</footer>

  </div>

  <script>
    // ===== 設定 =====
    const MAX_QUESTIONS = 100;
    const MAX_BAR_DISPLAY = 20; // 棒グラフに表示する直近セッション数

    // ===== 語彙データ（内蔵） =====
    let WORDS = [
      {en:"analyze", ja:"分析する"}, {en:"analysis", ja:"分析"}, {en:"approach", ja:"取り組み方"}, {en:"assess", ja:"評価する"},
      {en:"assessment", ja:"評価"}, {en:"assume", ja:"仮定する"}, {en:"assumption", ja:"仮定"}, {en:"benefit", ja:"利益"},
      {en:"challenge", ja:"難題"}, {en:"characteristic", ja:"特性"}, {en:"circumstance", ja:"状況"}, {en:"cite", ja:"引用する"},
      {en:"coherent", ja:"首尾一貫した"}, {en:"compare", ja:"比較する"}, {en:"complex", ja:"複雑な"}, {en:"component", ja:"構成要素"},
      {en:"concept", ja:"概念"}, {en:"conclude", ja:"結論づける"}, {en:"conclusion", ja:"結論"}, {en:"conduct", ja:"実施する"},
      {en:"confirm", ja:"確認する"}, {en:"consequence", ja:"結果"}, {en:"consider", ja:"考慮する"}, {en:"consistent", ja:"一貫した"},
      {en:"construct", ja:"構築する"}, {en:"context", ja:"文脈"}, {en:"contrast", ja:"対比"}, {en:"contribute", ja:"貢献する"},
      {en:"contribution", ja:"貢献"}, {en:"conventional", ja:"従来の"}, {en:"convince", ja:"納得させる"}, {en:"core", ja:"中核"},
      {en:"create", ja:"創造する"}, {en:"credible", ja:"信頼できる"}, {en:"criteria", ja:"基準"}, {en:"critical", ja:"重要な"},
      {en:"crucial", ja:"極めて重要な"}, {en:"data", ja:"資料"}, {en:"debate", ja:"討論"}, {en:"define", ja:"定義する"},
      {en:"definition", ja:"定義"}, {en:"demonstrate", ja:"実証する"}, {en:"derive", ja:"引き出す"}, {en:"describe", ja:"記述する"},
      {en:"description", ja:"記述"}, {en:"design", ja:"設計する"}, {en:"detail", ja:"詳細"}, {en:"determine", ja:"決定する"},
      {en:"develop", ja:"発展させる"}, {en:"device", ja:"装置"}, {en:"distinct", ja:"明確に異なる"}, {en:"distribute", ja:"分配する"},
      {en:"distribution", ja:"分布"}, {en:"economy", ja:"経済"}, {en:"effective", ja:"効果的な"}, {en:"efficient", ja:"効率的な"},
      {en:"emerge", ja:"現れる"}, {en:"emphasis", ja:"強調"}, {en:"encounter", ja:"遭遇する"}, {en:"enhance", ja:"向上させる"},
      {en:"ensure", ja:"確実にする"}, {en:"establish", ja:"確立する"}, {en:"estimate", ja:"見積もる"}, {en:"evidence", ja:"証拠"},
      {en:"evident", ja:"明白な"}, {en:"evolve", ja:"進化する"}, {en:"exceed", ja:"超える"}, {en:"exclude", ja:"除外する"},
      {en:"explicit", ja:"明示的な"}, {en:"expose", ja:"さらす"}, {en:"factor", ja:"要因"}, {en:"feature", ja:"特徴"},
      {en:"fund", ja:"資金を供給する"}, {en:"function", ja:"機能"}, {en:"generate", ja:"生み出す"}, {en:"hypothesis", ja:"仮説"},
      {en:"identify", ja:"特定する"}, {en:"illustrate", ja:"例示する"}, {en:"impact", ja:"影響"}, {en:"implement", ja:"実行する"},
      {en:"imply", ja:"ほのめかす"}, {en:"improve", ja:"改善する"}, {en:"include", ja:"含む"}, {en:"increase", ja:"増加させる"},
      {en:"indicate", ja:"示す"}, {en:"individual", ja:"個人の"}, {en:"infer", ja:"推論する"}, {en:"influence", ja:"影響を与える"},
      {en:"initial", ja:"最初の"}, {en:"innovate", ja:"革新する"}, {en:"insight", ja:"洞察"}, {en:"instance", ja:"例"},
      {en:"institute", ja:"設ける"}, {en:"integrate", ja:"統合する"}, {en:"interpret", ja:"解釈する"}, {en:"investigate", ja:"調査する"},
      {en:"involve", ja:"関与させる"}, {en:"issue", ja:"問題"}, {en:"justify", ja:"正当化する"}, {en:"labor", ja:"労働"},
      {en:"layer", ja:"層"}, {en:"legal", ja:"合法の"}, {en:"limit", ja:"制限する"}, {en:"maintain", ja:"維持する"},
      {en:"major", ja:"主要な"}, {en:"method", ja:"方法"}, {en:"minor", ja:"小さい"}, {en:"monitor", ja:"監視する"},
      {en:"network", ja:"通信網"}, {en:"notion", ja:"概念"}, {en:"objective", ja:"目的"}, {en:"obtain", ja:"得る"},
      {en:"occur", ja:"起こる"}, {en:"outcome", ja:"結果"}, {en:"overall", ja:"全体的な"}, {en:"participate", ja:"参加する"},
      {en:"perceive", ja:"知覚する"}, {en:"period", ja:"期間"}, {en:"persist", ja:"持続する"}, {en:"perspective", ja:"観点"},
      {en:"policy", ja:"方針"}, {en:"predict", ja:"予測する"}, {en:"previous", ja:"前の"}, {en:"principle", ja:"原理"},
      {en:"proceed", ja:"進む"}, {en:"process", ja:"過程"}, {en:"produce", ja:"生産する"}, {en:"professional", ja:"職業上の"},
      {en:"proportion", ja:"比率"}, {en:"propose", ja:"提案する"}, {en:"prospect", ja:"見込み"}, {en:"publish", ja:"出版する"},
      {en:"range", ja:"範囲"}, {en:"react", ja:"反応する"}, {en:"reasonable", ja:"妥当な"}, {en:"recognize", ja:"認識する"},
      {en:"recover", ja:"回復する"}, {en:"relevant", ja:"関連のある"}, {en:"rely", ja:"頼る"}, {en:"remark", ja:"言及"},
      {en:"remove", ja:"取り除く"}, {en:"require", ja:"要求する"}, {en:"research", ja:"研究"}, {en:"resident", ja:"居住者"},
      {en:"resolve", ja:"解決する"}, {en:"resource", ja:"資源"}, {en:"respond", ja:"応答する"}, {en:"restrict", ja:"制限する"},
      {en:"result", ja:"結果"}, {en:"retain", ja:"保持する"}, {en:"reveal", ja:"明らかにする"}, {en:"role", ja:"役割"},
      {en:"sector", ja:"部門"}, {en:"select", ja:"選択する"}, {en:"sequence", ja:"連続"}, {en:"significant", ja:"重要な"},
      {en:"similar", ja:"類似した"}, {en:"source", ja:"源"}, {en:"specify", ja:"特定する"}, {en:"structure", ja:"構造"},
      {en:"style", ja:"様式"}, {en:"subsequent", ja:"その後の"}, {en:"substitute", ja:"代用する"}, {en:"summary", ja:"要約"},
      {en:"survey", ja:"調査"}, {en:"sustain", ja:"持続させる"}, {en:"text", ja:"本文"}, {en:"theory", ja:"理論"},
      {en:"transfer", ja:"移転する"}, {en:"trend", ja:"傾向"}, {en:"variable", ja:"変数"}, {en:"vary", ja:"変化する"},
      {en:"verify", ja:"検証する"}, {en:"version", ja:"版"}, {en:"via", ja:"経由で"}, {en:"visual", ja:"視覚の"},
      {en:"achieve", ja:"達成する"}, {en:"adapt", ja:"適応する"}, {en:"adequate", ja:"十分な"}, {en:"adjacent", ja:"隣接した"},
      {en:"advocate", ja:"主張する"}, {en:"allocate", ja:"割り当てる"}, {en:"alter", ja:"変更する"}, {en:"ambiguous", ja:"曖昧な"},
      {en:"amend", ja:"修正する"}, {en:"analogous", ja:"類似した"}, {en:"anticipate", ja:"予期する"}, {en:"apparent", ja:"明らかな"},
      {en:"appropriate", ja:"適切な"}, {en:"arbitrary", ja:"恣意的な"}, {en:"attribute", ja:"属性"}, {en:"bias", ja:"偏り"},
      {en:"capable", ja:"能力がある"}, {en:"capacity", ja:"容量"}, {en:"cease", ja:"やめる"}, {en:"clarify", ja:"明確にする"},
      {en:"collapse", ja:"崩壊する"}, {en:"compile", ja:"編集する"}, {en:"comprise", ja:"構成する"}, {en:"conceive", ja:"思いつく"},
      {en:"confer", ja:"協議する"}, {en:"confine", ja:"限定する"}, {en:"conform", ja:"従う"}, {en:"consent", ja:"同意"},
      {en:"constant", ja:"一定の"}, {en:"constitute", ja:"構成する"}, {en:"constrain", ja:"拘束する"}, {en:"consult", ja:"相談する"},
      {en:"consume", ja:"消費する"}, {en:"contemporary", ja:"同時代の"}, {en:"contract", ja:"契約"}, {en:"contradict", ja:"矛盾する"},
      {en:"contrary", ja:"反対の"}, {en:"convert", ja:"変換する"}, {en:"coordinate", ja:"調整する"}, {en:"correspond", ja:"一致する"},
      {en:"couple", ja:"結びつける"}, {en:"currency", ja:"通貨"}, {en:"decline", ja:"減少する"}, {en:"deduce", ja:"推論する"},
      {en:"definite", ja:"明確な"}, {en:"depress", ja:"落ち込ませる"}, {en:"derive", ja:"由来する"}, {en:"devote", ja:"ささげる"},
      {en:"diminish", ja:"減少させる"}, {en:"discrete", ja:"離散の"}, {en:"display", ja:"表示する"}, {en:"diverse", ja:"多様な"},
      {en:"domain", ja:"領域"}, {en:"domestic", ja:"国内の"}, {en:"eliminate", ja:"除去する"}, {en:"empirical", ja:"経験的な"},
      {en:"encounter", ja:"出会う"}, {en:"enormous", ja:"巨大な"}, {en:"ensure", ja:"保証する"}, {en:"entity", ja:"実体"},
      {en:"equip", ja:"装備する"}, {en:"equivalent", ja:"同等の"}, {en:"estimation", ja:"見積り"}, {en:"ethic", ja:"倫理"},
      {en:"evaluate", ja:"評価する"}, {en:"exceed", ja:"上回る"}, {en:"exhibit", ja:"展示する"}, {en:"expand", ja:"拡大する"},
      {en:"expert", ja:"専門家"}, {en:"explicit", ja:"明白な"}, {en:"facilitate", ja:"促進する"}, {en:"feasible", ja:"実現可能な"},
      {en:"fluctuate", ja:"変動する"}, {en:"foundation", ja:"基盤"}, {en:"framework", ja:"枠組み"}, {en:"fundamental", ja:"基本的な"},
      {en:"grade", ja:"等級"}, {en:"grant", ja:"許可する"}, {en:"guarantee", ja:"保証する"}, {en:"highlight", ja:"強調する"},
      {en:"hence", ja:"それゆえ"}, {en:"idea", ja:"考え"}, {en:"identify", ja:"識別する"}, {en:"ignore", ja:"無視する"},
      {en:"illustrate", ja:"説明する"}, {en:"immune", ja:"免疫の"}, {en:"impose", ja:"課す"}, {en:"incentive", ja:"動機づけ"},
      {en:"incline", ja:"傾ける"}, {en:"inherent", ja:"本質的な"}, {en:"inhibit", ja:"抑制する"}, {en:"initiate", ja:"開始する"},
      {en:"insert", ja:"挿入する"}, {en:"instance", ja:"実例"}, {en:"intense", ja:"強烈な"}, {en:"interact", ja:"相互作用する"},
      {en:"interpret", ja:"通訳する"}, {en:"interval", ja:"間隔"}, {en:"intrinsic", ja:"内在的な"}, {en:"invest", ja:"投資する"},
      {en:"involve", ja:"含む"}, {en:"isolate", ja:"隔離する"}, {en:"legislate", ja:"立法する"}, {en:"license", ja:"許可"},
      {en:"logic", ja:"論理"}, {en:"mature", ja:"成熟した"}, {en:"mediate", ja:"仲介する"}, {en:"medium", ja:"媒体"},
      {en:"mode", ja:"方式"}, {en:"motivate", ja:"動機づける"}, {en:"negate", ja:"否定する"}, {en:"neutral", ja:"中立の"},
      {en:"notwithstanding", ja:"〜にもかかわらず"}, {en:"obtain", ja:"獲得する"}, {en:"occupy", ja:"占める"}, {en:"odd", ja:"奇妙な"},
      {en:"offset", ja:"相殺する"}, {en:"ongoing", ja:"進行中の"}, {en:"option", ja:"選択肢"}, {en:"orient", ja:"方向づける"},
      {en:"outcome", ja:"成果"}, {en:"overlap", ja:"重複する"}, {en:"panel", ja:"委員会"}, {en:"paradigm", ja:"範型"},
      {en:"parameter", ja:"媒介変数"}, {en:"participate", ja:"関与する"}, {en:"periodic", ja:"周期的な"}, {en:"phenomenon", ja:"現象"},
      {en:"plus", ja:"加えて"}, {en:"portion", ja:"一部"}, {en:"pose", ja:"提起する"}, {en:"precise", ja:"正確な"},
      {en:"predict", ja:"見通す"}, {en:"preliminary", ja:"予備の"}, {en:"presume", ja:"推定する"}, {en:"previous", ja:"以前の"},
      {en:"prime", ja:"主要な"}, {en:"principal", ja:"主要な"}, {en:"priority", ja:"優先事項"}, {en:"qualitative", ja:"質的な"},
      {en:"quantitative", ja:"量的な"}, {en:"quote", ja:"引用する"}, {en:"ratio", ja:"比率"}, {en:"rational", ja:"理性的な"},
      {en:"recover", ja:"取り戻す"}, {en:"regime", ja:"体制"}, {en:"reinforce", ja:"強化する"}, {en:"reject", ja:"拒否する"},
      {en:"relax", ja:"緩和する"}, {en:"rely", ja:"依拠する"}, {en:"restore", ja:"復元する"}, {en:"restrict", ja:"制約する"},
      {en:"revenue", ja:"歳入"}, {en:"reverse", ja:"逆にする"}, {en:"revise", ja:"改訂する"}, {en:"scheme", ja:"計画"},
      {en:"scope", ja:"範囲"}, {en:"shift", ja:"移す"}, {en:"simulate", ja:"模擬する"}, {en:"so-called", ja:"いわゆる"},
      {en:"specify", ja:"明記する"}, {en:"stable", ja:"安定した"}, {en:"statistic", ja:"統計"}, {en:"strategy", ja:"戦略"},
      {en:"stress", ja:"強調する"}, {en:"subsidy", ja:"補助金"}, {en:"sum", ja:"合計"}, {en:"suspend", ja:"一時停止する"},
      {en:"sustain", ja:"支える"}, {en:"target", ja:"目標"}, {en:"task", ja:"課題"}, {en:"team", ja:"班"}
    ];

    // ====== 状態管理 ======
    let asked = 0;
    let correct = 0;
    let mastered = new Set(JSON.parse(localStorage.getItem('toefl_mastered')||'[]'));
    let sessions = JSON.parse(localStorage.getItem('toefl_sessions')||'[]'); // 各セッション（100問）の記録: {t, rate}

    // ====== 要素参照 ======
    const askedEl = document.getElementById('asked');
    const correctEl = document.getElementById('correct');
    const rateEl = document.getElementById('rate');
    const masteredCountEl = document.getElementById('masteredCount');
    const promptEl = document.getElementById('prompt');
    const choicesEl = document.getElementById('choices');
    const feedbackEl = document.getElementById('feedback');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const resetBtn = document.getElementById('resetBtn');
    const loadCustomBtn = document.getElementById('loadCustomBtn');
    const exportBtn = document.getElementById('exportBtn');
    const customArea = document.getElementById('customArea');

    const chart = document.getElementById('chart');
    const ctx = chart.getContext('2d');

    // ====== ユーティリティ ======
    const rnd = (n)=>Math.floor(Math.random()*n);
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=rnd(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    function save(){
      localStorage.setItem('toefl_mastered', JSON.stringify([...mastered]));
      localStorage.setItem('toefl_sessions', JSON.stringify(sessions));
    }

    function updateStats(){
      askedEl.textContent = `${asked} / ${MAX_QUESTIONS}`;
      correctEl.textContent = `${correct}`;
      const rate = asked ? Math.round((correct/asked)*100) : 0;
      rateEl.textContent = rate + '%';
      masteredCountEl.textContent = `${mastered.size}`;
    }

    function recordSession(){
      const rate = asked? (correct/asked) : 0;
      sessions.push({ t: Date.now(), rate });
      // keep only recent 200 sessions to avoid unbounded growth
      if(sessions.length>200) sessions = sessions.slice(-200);
      save();
      drawChart();
    }

    function drawChart(){
      ctx.clearRect(0,0,chart.width,chart.height);
      // 背景グリッド
      ctx.strokeStyle = '#153a2f'; ctx.lineWidth = 1;
      for(let i=0;i<=5;i++){ const y = chart.height - 8 - (chart.height-16)*(i/5); ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(chart.width,y); ctx.stroke(); }

      const data = sessions.slice(-MAX_BAR_DISPLAY);
      if(data.length===0) return;

      const pad = 24;
      const availableW = chart.width - pad*2;
      const barW = Math.max(12, Math.floor(availableW / data.length) - 6);
      const gap = Math.max(6, Math.floor((availableW - barW*data.length) / Math.max(1, data.length-1)));

      data.forEach((s, idx)=>{
        const x = pad + idx*(barW + gap);
        const h = Math.max(2, Math.floor((chart.height - pad*2) * s.rate)); // rate: 0..1
        const y = chart.height - pad - h;
        // バー
        ctx.fillStyle = s.rate>=0.7 ? getComputedStyle(document.documentElement).getPropertyValue('--accent-2') : getComputedStyle(document.documentElement).getPropertyValue('--accent');
        ctx.fillRect(x, y, barW, h);
        // ラベル（%）
        ctx.fillStyle = '#b8dbc7'; ctx.font = '12px system-ui, sans-serif'; ctx.textAlign='center';
        ctx.fillText(Math.round(s.rate*100)+'%', x + barW/2, y - 6);
      });

      // x軸ラベル（最新セッションが右）
      ctx.fillStyle = '#9fcfb4'; ctx.font='11px system-ui, sans-serif'; ctx.textAlign='right';
      ctx.fillText('最新 →', chart.width - 6, chart.height - 6);
    }

    // ====== 出題ロジック ======
    let current = null; // {en, ja}
    let currentChoices = [];

    function availablePool(){
      return WORDS.filter(w=>!mastered.has(w.ja));
    }

    function nextQuestion(){
      if(asked >= MAX_QUESTIONS){
        // セッション終了
        promptEl.textContent = '100問が終了しました。セッションを記録しました。';
        choicesEl.innerHTML = '';
        nextBtn.disabled = true; skipBtn.disabled = true;
        recordSession();
        return;
      }
      feedbackEl.textContent=''; feedbackEl.className='feedback';
      const pool = availablePool();
      if(pool.length===0){
        promptEl.textContent = '出題可能な問題がありません（すべて習得済み）。語彙を追加するかリセットしてください。';
        choicesEl.innerHTML = '';
        nextBtn.disabled = true;
        return;
      }
      current = pool[rnd(pool.length)];
      promptEl.textContent = current.ja;

      // 選択肢作成
      const others = WORDS.filter(w=>w.en!==current.en);
      shuffle(others);
      const distractors = others.slice(0,3).map(w=>w.en);
      currentChoices = shuffle([current.en, ...distractors]);

      // レンダリング
      choicesEl.innerHTML = '';
      currentChoices.forEach((label)=>{
        const btn = document.createElement('button');
        btn.className='choice'; btn.textContent = label;
        btn.onclick = ()=>choose(label, btn);
        choicesEl.appendChild(btn);
      });
      nextBtn.disabled = true;
    }

    function lockChoices(){
      [...document.querySelectorAll('.choice')].forEach(b=>b.disabled=true);
    }

    function choose(label, btn){
      const isCorrect = label===current.en;
      asked++;
      if(isCorrect){ correct++; mastered.add(current.ja); }
      updateStats();

      lockChoices();
      [...document.querySelectorAll('.choice')].forEach(b=>{ if(b.textContent===current.en){ b.classList.add('correct'); } });
      if(!isCorrect){ btn.classList.add('wrong'); }

      feedbackEl.textContent = isCorrect ? `正解：${current.en}` : `不正解：正解は ${current.en}`;
      feedbackEl.className = 'feedback ' + (isCorrect ? 'ok':'ng');

      save();
      nextBtn.disabled = false;
    }

    // ====== イベント ======
    nextBtn.addEventListener('click', nextQuestion);
    skipBtn.addEventListener('click', ()=>{ nextQuestion(); });
    resetBtn.addEventListener('click', ()=>{
      if(!confirm('履歴（セッション）と習得済みを初期化します。よろしいですか？')) return;
      asked=0; correct=0; mastered=new Set(); sessions=[]; save(); updateStats(); drawChart(); nextQuestion();
    });

    loadCustomBtn.addEventListener('click', ()=>{
      const text = customArea.value.trim();
      if(!text){ alert('読み込むテキストが空です'); return; }
      const lines = text.split(/
+/);
      const parsed = [];
      for(const ln of lines){
        const m = ln.split(',');
        if(m.length<2) continue;
        const en = m[0].trim();
        const ja = m.slice(1).join(',').trim();
        if(en && ja) parsed.push({en, ja});
      }
      if(parsed.length===0){ alert('有効な行が見つかりませんでした。形式: 英語,日本語'); return; }
      WORDS = parsed;
      // セッションは保持（ユーザー要望に応じてクリア可能）
      asked=0; correct=0; updateStats(); drawChart(); nextQuestion();
      alert(`語彙を${WORDS.length}件読み込みました。`);
    });

    exportBtn.addEventListener('click', ()=>{
      const rows = WORDS.map(w=>`${w.en},${w.ja}`).join('
');
      const blob = new Blob([rows], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'toefl_words.csv'; a.click();
      URL.revokeObjectURL(url);
    });

    // ====== 初期化 ======
    function init(){
      updateStats(); drawChart(); nextQuestion();
    }

    init();
  </script>
</body>
</html>
