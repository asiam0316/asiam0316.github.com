<!DOCTYPE HTML>
<html>
  <head>
    <title>TOEFL対策 英単語4択（日本語→英語）</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="assets/css/main.css" />
    <noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
    <style>
      .choices {
        display: grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap: 12px;
        margin: 16px 0;
      }
      .choices .button {
        width: 100%;
        box-sizing: border-box;
      }
      .stat {
        background: rgba(255,255,255,0.04);
        padding: 14px 12px;
        border-radius: 10px;
        margin-bottom: 12px;
        font-size: 1em;
        border: 1px solid rgba(255,255,255,0.08);
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
        min-width: 120px;
      }
      .stat .label { font-size: 12px; color: #aaa; }
      .stat .value { font-size: 20px; font-weight: bold; color: #fff; }
      .feedback {
        min-height: 28px;
        margin-top: 8px;
        font-weight: bold;
        font-size: 16px;
      }
      .feedback.ok { color: #22c55e; }
      .feedback.ng { color: #ef4444; }
      .chart-wrap {
        width: 100%; 
        overflow: hidden; 
        margin-bottom: 10px;
      }
      #chart {
        width: 100%; 
        height: 140px; 
        display: block; 
        border-radius: 12px; 
        background: #0b241d;
        border:1px solid #1f4b3a;
      }
      .small { font-size: 12px; color: #999; }
      textarea { width:100%; min-height:120px; border-radius:8px; border:1px solid #27463e; background:#1b2e26; color:#e8faef; padding:10px; }
      .title-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 18px;
        margin-bottom: 10px;
      }
      @media (max-width: 600px) {
        .title-row {
          flex-direction: column;
          gap: 8px;
          align-items: stretch;
        }
      }
    </style>
  </head>
  <body class="is-preload">
    <div id="wrapper">
      <div id="main" style="display:block;">
        <article id="toefl">
          <div class="title-row">
            <a href="index.html" class="button small">← Home</a>
            <h2 class="major" style="margin-bottom:0;">TOEFL 英単語4択テスト</h2>
          </div>

          <div class="box">
            <div class="row" style="display:flex; flex-wrap:wrap; gap:16px; margin-bottom:10px;">
              <div class="stat">
                <span class="label">出題</span>
                <span class="value" id="asked">0 / 100</span>
              </div>
              <div class="stat">
                <span class="label">正答</span>
                <span class="value" id="correct">0</span>
              </div>
              <div class="stat">
                <span class="label">正答率</span>
                <span class="value" id="rate">0%</span>
              </div>
              <div class="stat">
                <span class="label">習得済み（再出題なし）</span>
                <span class="value" id="masteredCount">0</span>
              </div>
            </div>
          </div>

          <div class="box">
            <h3 class="major" id="prompt">ここに日本語が表示されます</h3>
            <div class="choices" id="choices"></div>
            <div class="feedback" id="feedback"></div>
            <ul class="actions">
              <li><button class="button primary" id="nextBtn" disabled>次の問題</button></li>
              <li><button class="button" id="skipBtn">スキップ</button></li>
              <li><button class="button" id="resetBtn" title="履歴と習得語を初期化">リセット</button></li>
            </ul>
          </div>

          <div class="box">
            <div class="row" style="align-items:flex-end; display: flex; flex-wrap: wrap;">
              <div style="flex:2 1 420px;min-width:300px;">
                <span class="small">正答率の推移（時系列）</span>
                <div class="chart-wrap">
                  <canvas id="chart" width="900" height="140" aria-label="正答率推移"></canvas>
                </div>
              </div>
              <div style="flex:1 1 260px;min-width:220px;">
                <span class="small">カスタム単語（1行に「英語,日本語」）</span>
                <textarea id="customArea" placeholder="例) evidence,証拠\nabstract,抽象的な\ninvestigate,調査する"></textarea>
                <ul class="actions" style="margin-top:8px;">
                  <li><button class="button primary" id="loadCustomBtn">読み込み</button></li>
                  <li><button class="button" id="exportBtn">語彙を書き出し</button></li>
                </ul>
                <span class="small">※ 読み込むと現在の語彙に置き換えます。習得済みは保持。ローカルストレージに履歴を保存します。</span>
              </div>
            </div>
          </div>
        </article>
      </div>
      <footer id="footer">
        <p>&copy; 2025 Toku. Design: <a href="https://html5up.net" target="_blank" rel="noopener">HTML5 UP</a></p>
      </footer>
    </div>
    <div id="bg"></div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/browser.min.js"></script>
    <script src="assets/js/breakpoints.min.js"></script>
    <script src="assets/js/util.js"></script>
    <script src="assets/js/main.js"></script>
    <script>
    // ===== 設定 =====
    const MAX_QUESTIONS = 100;

    let WORDS = [
      // ...（省略：設問用英単語リストは前回回答と同じです）...
      {en:"analyze", ja:"分析する"}, {en:"analysis", ja:"分析"}, /* ...（以下略）... */ {en:"team", ja:"班"}
    ];

    let asked = 0;
    let correct = 0;
    let mastered = new Set(JSON.parse(localStorage.getItem('toefl_mastered')||'[]'));
    let history = JSON.parse(localStorage.getItem('toefl_history')||'[]');

    const askedEl = document.getElementById('asked');
    const correctEl = document.getElementById('correct');
    const rateEl = document.getElementById('rate');
    const masteredCountEl = document.getElementById('masteredCount');
    const promptEl = document.getElementById('prompt');
    const choicesEl = document.getElementById('choices');
    const feedbackEl = document.getElementById('feedback');
    const nextBtn = document.getElementById('nextBtn');
    const skipBtn = document.getElementById('skipBtn');
    const resetBtn = document.getElementById('resetBtn');
    const loadCustomBtn = document.getElementById('loadCustomBtn');
    const exportBtn = document.getElementById('exportBtn');
    const customArea = document.getElementById('customArea');
    const chart = document.getElementById('chart');
    const ctx = chart.getContext('2d');

    const rnd = (n)=>Math.floor(Math.random()*n);
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=rnd(i+1); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function save(){
      localStorage.setItem('toefl_mastered', JSON.stringify([...mastered]));
      localStorage.setItem('toefl_history', JSON.stringify(history));
    }
    function updateStats(){
      askedEl.textContent = `${asked} / ${MAX_QUESTIONS}`;
      correctEl.textContent = `${correct}`;
      const rate = asked ? Math.round((correct/asked)*100) : 0;
      rateEl.textContent = rate + '%';
      masteredCountEl.textContent = `${mastered.size}`;
    }
    function record(correctNow){
      const rate = (asked? (correct/asked):0);
      history.push({ t: Date.now(), asked, correct, rate });
      save();
      drawChart();
    }
    function drawChart(){
      ctx.clearRect(0,0,chart.width, chart.height);
      ctx.strokeStyle = '#1f4b3a';
      ctx.lineWidth = 1;
      for(let i=0;i<=5;i++){
        const y = chart.height - (chart.height-8) * (i/5) - 4;
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(chart.width,y); ctx.stroke();
      }
      if(history.length===0) return;
      const maxX = Math.max(...history.map(h=>h.asked));
      const pad = 8;
      ctx.beginPath();
      history.forEach((h, idx)=>{
        const x = pad + (chart.width - pad*2) * (h.asked / Math.max(1, maxX));
        const y = (chart.height - pad) - (chart.height - pad*2) * h.rate;
        if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.strokeStyle = '#22c55e';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    let current = null;
    let currentChoices = [];
    function availablePool(){
      return WORDS.filter(w=>!mastered.has(w.ja));
    }
    function nextQuestion(){
      if(asked >= MAX_QUESTIONS){
        promptEl.textContent = '100問が終了しました。おつかれさま！';
        choicesEl.innerHTML = '';
        nextBtn.disabled = true;
        skipBtn.disabled = true;
        return;
      }
      feedbackEl.textContent=''; feedbackEl.className='feedback';
      const pool = availablePool();
      if(pool.length===0){
        promptEl.textContent = '出題可能な問題がありません（すべて習得済み）。語彙を追加するかリセットしてください。';
        choicesEl.innerHTML = '';
        nextBtn.disabled = true;
        return;
      }
      current = pool[rnd(pool.length)];
      promptEl.textContent = current.ja;
      const others = WORDS.filter(w=>w.en!==current.en);
      shuffle(others);
      const distractors = others.slice(0,3).map(w=>w.en);
      currentChoices = shuffle([current.en, ...distractors]);
      choicesEl.innerHTML = '';
      currentChoices.forEach((label)=>{
        const btn = document.createElement('button');
        btn.className='button';
        btn.textContent = label;
        btn.onclick = ()=>choose(label, btn);
        choicesEl.appendChild(btn);
      });
      nextBtn.disabled = true;
    }
    function lockChoices(){
      [...document.querySelectorAll('.choices .button')].forEach(b=>b.disabled=true);
    }
    function choose(label, btn){
      const isCorrect = label===current.en;
      asked++;
      if(isCorrect){ correct++; mastered.add(current.ja); }
      updateStats();
      lockChoices();
      [...document.querySelectorAll('.choices .button')].forEach(b=>{
        if(b.textContent===current.en){ b.classList.add('ok'); }
      });
      if(!isCorrect){ btn.classList.add('ng'); }
      feedbackEl.textContent = isCorrect ? `正解：${current.en}` : `不正解：正解は ${current.en}`;
      feedbackEl.className = 'feedback ' + (isCorrect ? 'ok':'ng');
      record(isCorrect);
      save();
      nextBtn.disabled = false;
    }
    nextBtn.addEventListener('click', nextQuestion);
    skipBtn.addEventListener('click', ()=>{ nextQuestion(); });
    resetBtn.addEventListener('click', ()=>{
      if(!confirm('履歴と習得済みを初期化します。よろしいですか？')) return;
      asked=0; correct=0; mastered=new Set(); history=[]; save(); updateStats(); drawChart(); nextQuestion();
    });
    loadCustomBtn.addEventListener('click', ()=>{
      const text = customArea.value.trim();
      if(!text){ alert('読み込むテキストが空です'); return; }
      const lines = text.split(/\n+/);
      const parsed = [];
      for(const ln of lines){
        const m = ln.split(',');
        if(m.length<2) continue;
        const en = m[0].trim();
        const ja = m.slice(1).join(',').trim();
        if(en && ja) parsed.push({en, ja});
      }
      if(parsed.length===0){ alert('有効な行が見つかりませんでした。形式: 英語,日本語'); return; }
      WORDS = parsed;
      asked=0; correct=0; history=[];
      save(); updateStats(); drawChart(); nextQuestion();
      alert(`語彙を${WORDS.length}件読み込みました。`);
    });
    exportBtn.addEventListener('click', ()=>{
      const rows = WORDS.map(w=>`${w.en},${w.ja}`).join('\n');
      const blob = new Blob([rows], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'toefl_words.csv'; a.click();
      URL.revokeObjectURL(url);
    });
    function initFromHistory(){
      if(history.length>0){
        const last = history[history.length-1];
        asked = last.asked; correct = last.correct;
      }
    }
    initFromHistory();
    updateStats();
    drawChart();
    nextQuestion();
    </script>
  </body>
</html>
